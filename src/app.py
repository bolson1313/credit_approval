import streamlit as st
import pandas as pd
from statisticss import StatisticsModule
from processing import ProcessingModule
from visualization import VisualizationModule
from utils import load_data, initialize_session_state, paginate_dataframe

def get_feature_descriptions():
    """Zwraca s≈Çownik z opisami cech dla datasetu Credit Approval"""
    return {
        'A1': {
            'name': 'P≈Çeƒá',
            'description': 'P≈Çeƒá wnioskodawcy (a/b)',
            'values': 'a, b'
        },
        'A2': {
            'name': 'Wiek',
            'description': 'Wiek wnioskodawcy',
            'values': 'warto≈õƒá numeryczna'
        },
        'A3': {
            'name': 'Stosunek_zad≈Çu≈ºenia',
            'description': 'Stosunek zad≈Çu≈ºenia wnioskodawcy',
            'values': 'warto≈õƒá numeryczna'
        },
        'A4': {
            'name': 'Status_cywilny',
            'description': 'Status cywilny wnioskodawcy',
            'values': 'u, y, l, t'
        },
        'A5': {
            'name': 'Typ_klienta_banku',
            'description': 'Typ klienta banku',
            'values': 'g, p, gg'
        },
        'A6': {
            'name': 'Poziom_wykszta≈Çcenia',
            'description': 'Poziom wykszta≈Çcenia wnioskodawcy',
            'values': 'c, d, cc, i, j, k, m, r, q, w, x, e, aa, ff'
        },
        'A7': {
            'name': 'Bran≈ºa_zatrudnienia',
            'description': 'Bran≈ºa zatrudnienia wnioskodawcy',
            'values': 'v, h, bb, j, n, z, dd, ff, o'
        },
        'A8': {
            'name': 'Sta≈º_zatrudnienia',
            'description': 'Sta≈º zatrudnienia wnioskodawcy',
            'values': 'warto≈õƒá numeryczna'
        },
        'A9': {
            'name': 'Ma_rachunek_RO',
            'description': 'Czy wnioskodawca ma rachunek RO',
            'values': 't (tak), f (nie)'
        },
        'A10': {
            'name': 'Ma_rachunek_OS',
            'description': 'Czy wnioskodawca ma rachunek OS',
            'values': 't (tak), f (nie)'
        },
        'A11': {
            'name': 'Liczba_aktywnych_kredyt√≥w',
            'description': 'Liczba aktywnych kredyt√≥w wnioskodawcy',
            'values': 'warto≈õƒá numeryczna'
        },
        'A12': {
            'name': 'Posiada_inne_zobowiƒÖzania',
            'description': 'Czy wnioskodawca posiada inne zobowiƒÖzania',
            'values': 't (tak), f (nie)'
        },
        'A13': {
            'name': 'Cel_kredytu',
            'description': 'Cel kredytu wnioskodawcy',
            'values': 'g, p, s'
        },
        'A14': {
            'name': 'D≈Çugo≈õƒá_historii_kredytowej',
            'description': 'D≈Çugo≈õƒá historii kredytowej wnioskodawcy',
            'values': 'warto≈õƒá numeryczna'
        },
        'A15': {
            'name': 'Roczny_doch√≥d',
            'description': 'Roczny doch√≥d wnioskodawcy',
            'values': 'warto≈õƒá numeryczna'
        },
        'A16': {
            'name': 'Decyzja_przyznania_kredytu',
            'description': 'Decyzja przyznania kredytu',
            'values': '+ (przyznano), - (odm√≥wiono)'
        }
    }

def show_feature_descriptions():
    """Wy≈õwietla tabelƒô z opisami cech"""
    st.markdown("### üìã Opis cech datasetu Credit Approval")
    
    descriptions = get_feature_descriptions()
    
    # Przygotuj dane do tabeli
    table_data = []
    for code, info in descriptions.items():
        table_data.append({
            'Kod cechy': code,
            'Proponowana nazwa': info['name'],
            'Opis': info['description'],
            'Mo≈ºliwe warto≈õci': info['values']
        })
    
    # Wy≈õwietl tabelƒô
    df_descriptions = pd.DataFrame(table_data)
    st.dataframe(df_descriptions, use_container_width=True, hide_index=True)
    
    st.markdown("""
    **‚ÑπÔ∏è Informacje dodatkowe:**
    - Dataset pochodzi z UCI Machine Learning Repository
    - Wszystkie nazwy atrybut√≥w i warto≈õci zosta≈Çy zmienione na bezsensu symbole w celu ochrony poufno≈õci
    - Zawiera 690 instancji z 15 atrybutami + klasƒÖ
    - 37 przypadk√≥w (5%) ma brakujƒÖce warto≈õci
    - Rozk≈Çad klas: + (przyznano): 307 (44.5%), - (odm√≥wiono): 383 (55.5%)
    """)

def main():
    st.set_page_config(
        page_title="Analiza Danych - Streamlit App",
        page_icon="üìä",
        layout="wide"
    )
    
    st.title("üìä Aplikacja do Analizy Danych")
    
    # Checkbox w g√≥rnej czƒô≈õci dla opisu cech
    show_descriptions = st.checkbox(
        "üìñ Poka≈º opis cech datasetu", 
        help="Wy≈õwietl tabelƒô z opisem wszystkich kolumn w datasecie Credit Approval"
    )
    
    if show_descriptions:
        show_feature_descriptions()
        st.markdown("---")
    
    st.markdown("---")
    
    # Inicjalizacja session state
    initialize_session_state()
    
    # Wczytywanie danych
    st.sidebar.header("üìÅ Wczytaj dane")
    uploaded_file = st.sidebar.file_uploader(
        "Wybierz plik CSV", 
        type=['csv'],
        help="Wczytaj plik CSV do analizy",
        key="file_uploader"
    )
    
    # Sprawdzenie czy plik zosta≈Ç wczytany lub zmieniony
    if uploaded_file is not None:
        # Sprawd≈∫ czy to nowy plik lub czy poprzedni zosta≈Ç usuniƒôty
        file_changed = (
            'uploaded_file_name' not in st.session_state or 
            st.session_state.get('uploaded_file_name') != uploaded_file.name or
            'current_data' not in st.session_state or
            st.session_state['current_data'] is None
        )
        
        if file_changed:
            df = load_data(uploaded_file)
            if df is not None:
                # Reset indeksu tylko przy wczytywaniu nowego pliku
                df = df.reset_index(drop=True)
                st.session_state['original_data'] = df.copy()
                st.session_state['current_data'] = df.copy()
                st.session_state['uploaded_file_name'] = uploaded_file.name
                
                # Informacje o danych
                st.sidebar.success(f"‚úÖ Wczytano dane: {df.shape[0]} wierszy, {df.shape[1]} kolumn")
    else:
        # Je≈õli nie ma pliku, wyczy≈õƒá dane
        if 'current_data' in st.session_state:
            st.session_state['current_data'] = None
            st.session_state['original_data'] = None
            if 'uploaded_file_name' in st.session_state:
                del st.session_state['uploaded_file_name']
    
    # Wy≈õwietlanie DataFrame nad zak≈Çadkami
    if 'current_data' in st.session_state and st.session_state['current_data'] is not None:
        df = st.session_state['current_data']
        
        # Sekcja g≈Ç√≥wnego datasetu
        st.header("üìã G≈Ç√≥wny dataset (edytowalny)")
        
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("Wiersze", len(df))
        with col2:
            st.metric("Kolumny", len(df.columns))
        with col3:
            st.metric("BrakujƒÖce warto≈õci", df.isnull().sum().sum())
        with col4:
            st.metric("Duplikaty", df.duplicated().sum())
        
        # Opcje wy≈õwietlania i kontroli
        col1, col2, col3 = st.columns([2, 1, 1])
        with col1:
            st.write("")  # Pusty placeholder
        with col2:
            refresh_button = st.button("üîÑ Od≈õwie≈º zmiany", help="Zastosuj wprowadzone zmiany do datasetu")
        with col3:
            reset_button = st.button("‚Ü©Ô∏è Resetuj do oryginalnych", help="Przywr√≥ƒá oryginalne dane")
        
        # Obs≈Çuga przycisk√≥w
        if reset_button:
            if 'original_data' in st.session_state:
                # Reset indeksu tylko przy resetowaniu do oryginalnych danych
                original_data = st.session_state['original_data'].copy().reset_index(drop=True)
                st.session_state['current_data'] = original_data
                st.success("Przywr√≥cono oryginalne dane!")
                st.rerun()
        
        # Edytowalny DataFrame - zawsze pe≈Çny z scrollem
        st.warning("üí° Edytuj dane bezpo≈õrednio w tabeli poni≈ºej, nastƒôpnie kliknij 'Od≈õwie≈º zmiany'")
        
        # Dodanie indeks√≥w jako kolumny dla lepszej widoczno≈õci
        df_with_index = df.copy()
        df_with_index.insert(0, 'Index', df_with_index.index)
        
        # Zawsze pe≈Çny dataset z scrollem
        edited_df = st.data_editor(
            df_with_index,
            use_container_width=True,
            height=600,  # Zwiƒôkszona wysoko≈õƒá dla lepszego scrollingu
            key="main_data_editor",
            num_rows="dynamic",  # Pozwala dodawaƒá/usuwaƒá wiersze
            column_config={
                "Index": st.column_config.NumberColumn(
                    "Index",
                    help="Indeks wiersza",
                    disabled=True,  # Nie mo≈ºna edytowaƒá indeksu
                    width="small"
                )
            }
        )
        
        # Zastosowanie zmian
        if refresh_button:
            if not edited_df.equals(df_with_index):
                # Usu≈Ñ kolumnƒô Index przed zapisaniem, ale zachowaj oryginalne indeksy DataFrame
                final_df = edited_df.drop('Index', axis=1)
                # NIE r√≥b reset_index - zachowaj oryginalne indeksy
                st.session_state['current_data'] = final_df.copy()
                st.success("‚úÖ Zmiany zosta≈Çy zastosowane do datasetu!")
                st.rerun()
            else:
                st.info("‚ÑπÔ∏è Brak zmian do zastosowania")
        
        st.markdown("---")
        
        # G≈Ç√≥wne zak≈Çadki
        tab1, tab2, tab3 = st.tabs(["üìà Statystyki", "üîß Przetwarzanie", "üìä Wizualizacje"])
        
        with tab1:
            stats_module = StatisticsModule()
            stats_module.render(st.session_state['current_data'])
        
        with tab2:
            proc_module = ProcessingModule()
            # Przetwarzanie wp≈Çywa na g≈Ç√≥wny dataset
            st.session_state['current_data'] = proc_module.render(st.session_state['current_data'])
        
        with tab3:
            viz_module = VisualizationModule()
            viz_module.render(st.session_state['current_data'])
    else:
        st.info("üëà Wczytaj plik CSV w panelu bocznym, aby rozpoczƒÖƒá analizƒô")
        
        # Przyk≈Çadowe dane
        st.subheader("üéØ Jak u≈ºywaƒá aplikacji:")
        st.markdown("""
        1. **Wczytaj dane**: U≈ºyj panelu bocznego, aby wczytaƒá plik CSV
        2. **Edytuj dane**: Modyfikuj dane bezpo≈õrednio w edytowalnej tabeli
        3. **Od≈õwie≈º zmiany**: Kliknij przycisk 'Od≈õwie≈º zmiany' aby zastosowaƒá edycje
        4. **Statystyki**: PrzeglƒÖdaj podstawowe statystyki i korelacje
        5. **Przetwarzanie**: Modyfikuj i czy≈õƒá dane (zmiany wp≈ÇywajƒÖ na g≈Ç√≥wny dataset)
        6. **Wizualizacje**: Tw√≥rz wykresy i analizy wizualne
        """)

if __name__ == "__main__":
    main()